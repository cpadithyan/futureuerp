<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future U - Physical-to-Digital ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .sidebar-item.active { background-color: #3b82f6; color: white; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #loadingOverlay { transition: opacity 0.5s ease-out; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .ledger-table thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        .in-cell { color: #059669; }
        .out-cell { color: #dc2626; }
        .sub-tab.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 800; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium text-sm tracking-wider uppercase">Future U<br><span class="text-[10px]">Financial Intelligence</span></p>
    </div>

    <!-- PIN Lock Overlay -->
    <div id="pinOverlay" class="fixed inset-0 bg-slate-900/95 z-[250] hidden flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="w-full max-w-xs text-center text-white">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-2xl mb-6 mx-auto shadow-xl"><i class="fas fa-key"></i></div>
            <h3 class="text-xl font-bold mb-2">Owner's Ledger Access</h3>
            <p class="text-slate-400 text-sm mb-8">Enter PIN to access Digital Books.</p>
            <div class="flex justify-center gap-3 mb-8">
                <div id="pin-1" class="w-4 h-4 rounded-full border-2 border-slate-600"></div>
                <div id="pin-2" class="w-4 h-4 rounded-full border-2 border-slate-600"></div>
                <div id="pin-3" class="w-4 h-4 rounded-full border-2 border-slate-600"></div>
                <div id="pin-4" class="w-4 h-4 rounded-full border-2 border-slate-600"></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="pressPin('1')" class="h-14 bg-slate-800 rounded-xl font-bold">1</button>
                <button onclick="pressPin('2')" class="h-14 bg-slate-800 rounded-xl font-bold">2</button>
                <button onclick="pressPin('3')" class="h-14 bg-slate-800 rounded-xl font-bold">3</button>
                <button onclick="pressPin('4')" class="h-14 bg-slate-800 rounded-xl font-bold">4</button>
                <button onclick="pressPin('5')" class="h-14 bg-slate-800 rounded-xl font-bold">5</button>
                <button onclick="pressPin('6')" class="h-14 bg-slate-800 rounded-xl font-bold">6</button>
                <button onclick="pressPin('7')" class="h-14 bg-slate-800 rounded-xl font-bold">7</button>
                <button onclick="pressPin('8')" class="h-14 bg-slate-800 rounded-xl font-bold">8</button>
                <button onclick="pressPin('9')" class="h-14 bg-slate-800 rounded-xl font-bold">9</button>
                <button onclick="clearPin()" class="h-14 bg-red-900/30 text-red-500 rounded-xl text-xs font-bold">CLR</button>
                <button onclick="pressPin('0')" class="h-14 bg-slate-800 rounded-xl font-bold">0</button>
                <button onclick="cancelPin()" class="h-14 bg-slate-800 text-slate-400 rounded-xl text-xs font-bold">ESC</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-2xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50 overflow-y-auto">
        <div class="p-6 border-b border-gray-50">
            <h1 class="text-2xl font-black text-blue-600 flex items-center gap-2">
                <i class="fas fa-graduation-cap"></i> FUTURE U
            </h1>
            <p class="text-[9px] text-gray-400 mt-1 uppercase tracking-[0.2em] font-extrabold text-center sm:text-left">Vision 2027 Dashboard</p>
        </div>
        <nav class="mt-4 px-4 space-y-1">
            <button onclick="showTab('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm">
                <i class="fas fa-chart-pie w-5"></i> Dashboard
            </button>
            <button onclick="showTab('students')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm">
                <i class="fas fa-user-graduate w-5"></i> Student List
            </button>
            <div class="pt-4 pb-2"><p class="text-[10px] text-gray-400 font-black uppercase tracking-widest px-4">The Digital Registers</p></div>
            <button onclick="showTab('ledger')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm">
                <i class="fas fa-book-open w-5"></i> All Ledgers <i class="fas fa-lock ml-auto text-[10px] opacity-20"></i>
            </button>
            <button onclick="showTab('owner')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm">
                <i class="fas fa-user-tie w-5"></i> Capital & Drawings <i class="fas fa-lock ml-auto text-[10px] opacity-20"></i>
            </button>
            <div class="pt-4 pb-2"><p class="text-[10px] text-gray-400 font-black uppercase tracking-widest px-4">Strategy</p></div>
            <button onclick="showTab('reports')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm">
                <i class="fas fa-file-invoice-dollar w-5"></i> P&L Reports
            </button>
        </nav>
    </aside>

    <!-- Main -->
    <main class="lg:ml-64 p-4 lg:p-10">
        <header class="flex justify-between items-center mb-10">
            <button class="lg:hidden text-2xl p-2 bg-white rounded-xl shadow-sm" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div>
                <h2 id="pageTitle" class="text-3xl font-black tracking-tight text-slate-800">Dashboard</h2>
                <p id="currentDate" class="text-sm font-semibold text-gray-400 mt-1"></p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Master Cash Balance</p>
                <p id="totalCashBalance" class="text-2xl font-black text-blue-600">₹0</p>
            </div>
        </header>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active space-y-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass-card p-6 rounded-3xl border-b-4 border-blue-500">
                    <p class="text-gray-400 font-bold text-[10px] uppercase tracking-widest">Active Enrollment</p>
                    <p id="statActive" class="text-3xl font-black mt-1">0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl border-b-4 border-emerald-500">
                    <p class="text-gray-400 font-bold text-[10px] uppercase tracking-widest">Institute Profit</p>
                    <p id="statProfit" class="text-3xl font-black mt-1 text-emerald-600">₹0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl border-b-4 border-red-500">
                    <p class="text-gray-400 font-bold text-[10px] uppercase tracking-widest">Fees Overdue</p>
                    <p id="statOverdue" class="text-3xl font-black mt-1 text-red-600">0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl border-b-4 border-indigo-500">
                    <p class="text-gray-400 font-bold text-[10px] uppercase tracking-widest">Vision Growth</p>
                    <p id="visionPercent" class="text-3xl font-black mt-1">0%</p>
                </div>
            </div>

            <!-- Quick Entry Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                    <h4 class="font-black text-lg mb-6 flex items-center gap-3 text-blue-600"><i class="fas fa-wallet"></i> Fee Collection (Income)</h4>
                    <form id="feeForm" class="space-y-4">
                        <select id="feeStudentSelect" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required></select>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="feeAmount" placeholder="Amount ₹" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                            <select id="feeMode" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm">
                                <option value="Cash">Cash</option>
                                <option value="UPI/Gpay">UPI / GPay</option>
                                <option value="Bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="feeReceipt" placeholder="Receipt No (Optional)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm">
                            <input type="date" id="feeDate" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-blue-700 transition-all">Record in Income Register</button>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                    <h4 class="font-black text-lg mb-6 flex items-center gap-3 text-red-600"><i class="fas fa-receipt"></i> Expense Payment</h4>
                    <form id="expenseForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="expName" placeholder="Purpose (What?)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                            <select id="expHead" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm">
                                <option value="Rent">Rent</option>
                                <option value="Electricity">Electricity</option>
                                <option value="Salary">Salary</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Internet">Internet</option>
                                <option value="Stationery">Stationery</option>
                                <option value="Misc">Miscellaneous</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="expAmount" placeholder="Amount ₹" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                            <select id="expMode" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm">
                                <option value="Cash">Cash</option>
                                <option value="UPI/Gpay">UPI / GPay</option>
                                <option value="Bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="expPaidBy" placeholder="Paid By (Name)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm">
                            <input type="date" id="expDate" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                        </div>
                        <button type="submit" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-red-600 transition-all">Record in Expense Register</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- DIGITAL LEDGERS TAB -->
        <div id="ledger" class="tab-content space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-gray-100 pb-4">
                <div class="flex gap-6 overflow-x-auto w-full sm:w-auto">
                    <button onclick="filterLedger('all')" id="tab-all" class="sub-tab p-2 text-xs font-black uppercase tracking-widest transition-all active">Master Cash Book</button>
                    <button onclick="filterLedger('Fee')" id="tab-Fee" class="sub-tab p-2 text-xs font-black uppercase tracking-widest transition-all">Income Register</button>
                    <button onclick="filterLedger('Expense')" id="tab-Expense" class="sub-tab p-2 text-xs font-black uppercase tracking-widest transition-all">Expense Register</button>
                </div>
                <button onclick="window.exportBackup()" class="bg-slate-100 px-4 py-2 rounded-xl text-xs font-black"><i class="fas fa-file-excel mr-2"></i> Export Data</button>
            </div>

            <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-gray-100">
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table class="w-full text-left ledger-table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Date</th>
                                <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Particulars / Description</th>
                                <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Mode</th>
                                <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest text-right">In (+)</th>
                                <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest text-right">Out (-)</th>
                                <th id="balanceHeader" class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest text-right bg-blue-50/50">Running Balance</th>
                            </tr>
                        </thead>
                        <tbody id="masterLedgerBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OWNER REGISTRY -->
        <div id="owner" class="tab-content space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-slate-900 p-10 rounded-[2.5rem] text-white shadow-2xl">
                    <h4 class="text-2xl font-black mb-6 text-blue-400">Capital & Drawings Register</h4>
                    <form id="ownerForm" class="space-y-5">
                        <select id="ownerType" class="w-full p-4 bg-white/10 rounded-2xl outline-none font-bold text-sm">
                            <option value="Capital">Capital Introduced (e.g. Father/Own money)</option>
                            <option value="Drawings">Owner Drawings (Taking money out)</option>
                        </select>
                        <input type="text" id="ownerParticulars" placeholder="Particulars (e.g. Monthly Support, Personal Chai)" class="w-full p-4 bg-white/10 rounded-2xl outline-none font-bold text-sm" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="ownerAmount" placeholder="Amount ₹" class="w-full p-4 bg-white/10 rounded-2xl outline-none font-bold text-sm" required>
                            <select id="ownerMode" class="w-full p-4 bg-white/10 rounded-2xl outline-none font-bold text-sm">
                                <option value="Cash">Cash</option>
                                <option value="UPI/Gpay">UPI / GPay</option>
                                <option value="Bank">Bank</option>
                            </select>
                        </div>
                        <input type="date" id="ownerDate" class="w-full p-4 bg-white/10 rounded-2xl outline-none font-bold text-sm" required>
                        <button type="submit" class="w-full bg-blue-500 text-white py-5 rounded-2xl font-black shadow-xl hover:bg-blue-600 transition-all">Record in Capital Register</button>
                    </form>
                </div>
                <div class="glass-card p-10 rounded-[2.5rem] flex flex-col justify-center space-y-8">
                    <div class="p-6 bg-blue-50 rounded-3xl">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Total Capital Support</p>
                        <p id="totalCapitalSum" class="text-3xl font-black text-blue-600">₹0</p>
                    </div>
                    <div class="p-6 bg-red-50 rounded-3xl">
                        <p class="text-[10px] font-black text-red-400 uppercase tracking-widest">Total Owner Drawings</p>
                        <p id="totalDrawingSum" class="text-3xl font-black text-red-600">₹0</p>
                    </div>
                    <p class="text-xs text-gray-400 font-medium leading-relaxed italic">
                        Tip: Maintain this accurately to know exactly how much of your own money is invested in Future U vs. what you take out.
                    </p>
                </div>
            </div>
        </div>

        <!-- STUDENTS -->
        <div id="students" class="tab-content space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-black">Admissions</h3>
                <button onclick="openModal('studentModal')" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-black shadow-lg"><i class="fas fa-plus mr-2"></i> New Admission</button>
            </div>
            <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-gray-100">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Student</th>
                            <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Course</th>
                            <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest">Next Due</th>
                            <th class="p-6 font-bold text-gray-400 uppercase text-[10px] tracking-widest text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="reports" class="tab-content">Reports logic integrated into Dashboard.</div>

    </main>

    <!-- Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[100] p-4 backdrop-blur-xl">
        <div class="bg-white w-full max-w-xl rounded-[2.5rem] p-10 relative">
            <button onclick="closeModal('studentModal')" class="absolute top-8 right-8 text-2xl font-black">&times;</button>
            <h3 class="text-2xl font-black mb-8">Admission Registry</h3>
            <form id="enrollmentForm" class="space-y-4">
                <input type="text" id="stuName" placeholder="Student Name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                <input type="text" id="stuCourse" placeholder="Course Name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                <input type="text" id="stuPhone" placeholder="Mobile Number" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="stuMlyFee" placeholder="Monthly Fee ₹" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                    <input type="date" id="stuDueDate" class="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl">Enroll & Record Admission</button>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notif" class="fixed bottom-10 right-10 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl font-bold hidden z-[500] animate-bounce"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB2bcDcHkL7mtu8Hy_XsrrCnJ1TRfzJNyc", authDomain: "futureuerp.firebaseapp.com", projectId: "futureuerp", storageBucket: "futureuerp.firebasestorage.app", messagingSenderId: "199842262718", appId: "1:199842262718:web:553ca10bb5da77656478ef" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'futureuerp';

        let appState = {
            students: [],
            transactions: [],
            currentFilter: 'all',
            user: null,
            adminPin: '4568',
            isAuthenticated: false,
            currentInputPin: '',
            targetTab: 'dashboard'
        };

        const showNotif = (msg) => {
            const n = document.getElementById('notif');
            n.innerText = msg; n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3000);
        };

        const updateUI = () => {
            const today = new Date();
            const sortedTx = [...appState.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            let runningBalance = 0;
            let ledgerHtml = '';
            let busRevenue = 0;
            let busExpense = 0;
            let capitalSum = 0;
            let drawingSum = 0;

            const filteredTx = sortedTx.filter(tx => appState.currentFilter === 'all' || tx.category === appState.currentFilter);

            sortedTx.forEach(tx => {
                const amt = Number(tx.amount);
                const isPositive = (tx.category === 'Fee' || tx.category === 'Capital');
                
                if (isPositive) {
                    runningBalance += amt;
                    if(tx.category === 'Fee') busRevenue += amt;
                    if(tx.category === 'Capital') capitalSum += amt;
                } else {
                    runningBalance -= amt;
                    if(tx.category === 'Expense') busExpense += amt;
                    if(tx.category === 'Drawings') drawingSum += amt;
                }

                // If this transaction is in our active filter, add to table
                if (appState.currentFilter === 'all' || tx.category === appState.currentFilter) {
                    ledgerHtml += `
                        <tr class="text-xs border-b hover:bg-gray-50/50">
                            <td class="p-6 font-bold text-gray-500">${tx.date}</td>
                            <td class="p-6"><p class="font-black text-slate-800">${tx.particulars}</p><p class="text-[9px] uppercase font-bold text-gray-400">${tx.head || tx.category}</p></td>
                            <td class="p-6 font-bold text-gray-400 uppercase text-[9px]">${tx.mode}</td>
                            <td class="p-6 text-right font-black ${isPositive ? 'in-cell' : 'text-gray-200'}">${isPositive ? '+' + amt.toLocaleString() : '-'}</td>
                            <td class="p-6 text-right font-black ${!isPositive ? 'out-cell' : 'text-gray-200'}">${!isPositive ? '-' + amt.toLocaleString() : '-'}</td>
                            <td class="p-6 text-right font-black ${appState.currentFilter === 'all' ? 'bg-blue-50/30' : 'text-gray-300'}">${appState.currentFilter === 'all' ? '₹' + runningBalance.toLocaleString() : '---'}</td>
                        </tr>
                    `;
                }
            });

            document.getElementById('masterLedgerBody').innerHTML = ledgerHtml || '<tr><td colspan="6" class="p-20 text-center text-gray-400 italic">Register is currently empty.</td></tr>';
            document.getElementById('totalCashBalance').innerText = `₹${runningBalance.toLocaleString()}`;
            document.getElementById('statProfit').innerText = `₹${(busRevenue - busExpense).toLocaleString()}`;
            document.getElementById('statActive').innerText = appState.students.length;
            document.getElementById('statOverdue').innerText = appState.students.filter(s => new Date(s.nextDueDate) < today).length;
            document.getElementById('visionPercent').innerText = Math.round((appState.students.length / 500) * 100) + '%';
            
            document.getElementById('totalCapitalSum').innerText = `₹${capitalSum.toLocaleString()}`;
            document.getElementById('totalDrawingSum').innerText = `₹${drawingSum.toLocaleString()}`;

            // Sync Dropdown
            document.getElementById('feeStudentSelect').innerHTML = '<option value="">Select Student...</option>' + 
                appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            // Student Table
            document.getElementById('studentTableBody').innerHTML = appState.students.map(s => `
                <tr class="border-b text-sm">
                    <td class="p-6 font-bold">${s.name}</td>
                    <td class="p-6 text-gray-500 font-medium">${s.course}</td>
                    <td class="p-6"><span class="px-2 py-1 rounded font-black text-[10px] ${new Date(s.nextDueDate) < today ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${s.nextDueDate}</span></td>
                    <td class="p-6 text-right"><button onclick="window.deleteStudent('${s.id}')" class="text-red-200 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.filterLedger = (filter) => {
            appState.currentFilter = filter;
            document.querySelectorAll('.sub-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${filter}`).classList.add('active');
            document.getElementById('balanceHeader').classList.toggle('bg-blue-50/50', filter === 'all');
            updateUI();
        };

        window.showTab = (tabId) => {
            const secretTabs = ['ledger', 'owner'];
            if (secretTabs.includes(tabId) && !appState.isAuthenticated) {
                appState.targetTab = tabId;
                document.getElementById('pinOverlay').classList.remove('hidden');
                return;
            }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.toggle('active', el.getAttribute('onclick').includes(tabId)));
            document.getElementById('pageTitle').innerText = tabId === 'ledger' ? "Digital Registers" : (tabId.charAt(0).toUpperCase() + tabId.slice(1));
            updateUI();
        };

        window.pressPin = (num) => {
            if (appState.currentInputPin.length < 4) {
                appState.currentInputPin += num;
                [1,2,3,4].forEach(i => document.getElementById(`pin-${i}`).classList.toggle('bg-blue-500', appState.currentInputPin.length >= i));
                if (appState.currentInputPin.length === 4) {
                    if (appState.currentInputPin === appState.adminPin) {
                        appState.isAuthenticated = true;
                        document.getElementById('pinOverlay').classList.add('hidden');
                        window.showTab(appState.targetTab);
                    } else {
                        showNotif("Invalid Pin");
                        appState.currentInputPin = '';
                        [1,2,3,4].forEach(i => document.getElementById(`pin-${i}`).classList.remove('bg-blue-500'));
                    }
                }
            }
        };
        window.clearPin = () => { appState.currentInputPin = ''; [1,2,3,4].forEach(i => document.getElementById(`pin-${i}`).classList.remove('bg-blue-500')); };
        window.cancelPin = () => { document.getElementById('pinOverlay').classList.add('hidden'); clearPin(); };

        // Submits
        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sId = document.getElementById('feeStudentSelect').value;
            const student = appState.students.find(s => s.id === sId);
            const amt = Number(document.getElementById('feeAmount').value);
            const date = document.getElementById('feeDate').value;
            const mode = document.getElementById('feeMode').value;
            const rec = document.getElementById('feeReceipt').value;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                category: 'Fee', particulars: `Fees - ${student.name}`, amount: amt, date: date, mode: mode, head: 'Fee Income', studentId: sId, receipt: rec
            });
            
            const nextDue = new Date(student.nextDueDate);
            nextDue.setMonth(nextDue.getMonth() + 1);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sId), { nextDueDate: nextDue.toISOString().split('T')[0] });
            
            showNotif("Income Register Updated!");
            e.target.reset();
        });

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                category: 'Expense', particulars: document.getElementById('expName').value, head: document.getElementById('expHead').value, amount: Number(document.getElementById('expAmount').value), mode: document.getElementById('expMode').value, date: document.getElementById('expDate').value, operator: document.getElementById('expPaidBy').value
            });
            showNotif("Expense Register Updated!");
            e.target.reset();
        });

        document.getElementById('ownerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                category: document.getElementById('ownerType').value, particulars: document.getElementById('ownerParticulars').value, amount: Number(document.getElementById('ownerAmount').value), mode: document.getElementById('ownerMode').value, date: document.getElementById('ownerDate').value
            });
            showNotif("Owner Entry Recorded!");
            e.target.reset();
        });

        document.getElementById('enrollmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), {
                name: document.getElementById('stuName').value, course: document.getElementById('stuCourse').value, phone: document.getElementById('stuPhone').value, mlyFee: Number(document.getElementById('stuMlyFee').value), nextDueDate: document.getElementById('stuDueDate').value
            });
            showNotif("New Admission Success!");
            closeModal('studentModal');
            e.target.reset();
        });

        window.deleteStudent = async (id) => { if(confirm("Permanently remove student?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); };
        
        window.exportBackup = () => {
            const data = { transactions: appState.transactions, students: appState.students };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `FutureU_Ledger_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
        };

        async function init() {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    appState.user = user;
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 500);
                    
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                        appState.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        updateUI();
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (snap) => {
                        appState.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        updateUI();
                    });
                }
            });
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const todayStr = new Date().toISOString().split('T')[0];
            ['feeDate', 'expDate', 'ownerDate', 'stuDueDate'].forEach(id => {
                const el = document.getElementById(id); if(el) el.value = todayStr;
            });
        }

        init().catch(console.error);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future U - Growth & Management ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .sidebar-item.active { background-color: #3b82f6; color: white; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-badge-active { background-color: #dcfce7; color: #166534; }
        .status-badge-stopped { background-color: #fee2e2; color: #991b1b; }
        #loadingOverlay { transition: opacity 0.5s ease-out; }
        .custom-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center text-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-6"></div>
        <h2 class="text-xl font-black text-slate-800 tracking-tighter">FUTURE U ERP</h2>
        <p class="text-gray-400 font-medium text-[10px] tracking-widest uppercase mt-2">Syncing Vision & Analytics...</p>
    </div>

    <!-- PIN Lock Overlay -->
    <div id="pinOverlay" class="fixed inset-0 bg-slate-900/98 z-[250] hidden flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="w-full max-w-xs text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center text-white text-3xl mb-8 mx-auto shadow-2xl">
                <i class="fas fa-lock"></i>
            </div>
            <h3 class="text-white text-2xl font-black mb-2 text-center">Owner Access</h3>
            <p class="text-slate-400 text-sm mb-10 text-center">PIN authorization required for financials.</p>
            <div class="flex justify-center gap-4 mb-10 text-center">
                <div id="pin-1" class="w-5 h-5 rounded-full border-2 border-slate-700"></div>
                <div id="pin-2" class="w-5 h-5 rounded-full border-2 border-slate-700"></div>
                <div id="pin-3" class="w-4 h-4 rounded-full border-2 border-slate-700"></div>
                <div id="pin-4" class="w-5 h-5 rounded-full border-2 border-slate-700"></div>
            </div>
            <div class="grid grid-cols-3 gap-5">
                <button onclick="pressPin('1')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">1</button>
                <button onclick="pressPin('2')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">2</button>
                <button onclick="pressPin('3')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">3</button>
                <button onclick="pressPin('4')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">4</button>
                <button onclick="pressPin('5')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">5</button>
                <button onclick="pressPin('6')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">6</button>
                <button onclick="pressPin('7')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">7</button>
                <button onclick="pressPin('8')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">8</button>
                <button onclick="pressPin('9')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">9</button>
                <button onclick="clearPin()" class="h-16 bg-red-900/20 text-red-500 rounded-2xl font-black">CLR</button>
                <button onclick="pressPin('0')" class="h-16 bg-slate-800 text-white rounded-2xl text-2xl font-black hover:bg-slate-700">0</button>
                <button onclick="cancelPin()" class="h-16 bg-slate-800 text-slate-400 rounded-2xl font-black">ESC</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-2xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50 overflow-y-auto">
        <div class="p-8 border-b border-gray-50">
            <h1 class="text-2xl font-black text-blue-600 flex items-center gap-2">
                <i class="fas fa-graduation-cap"></i> FUTURE U
            </h1>
            <p class="text-[9px] text-gray-400 mt-2 uppercase tracking-[0.2em] font-black">ERP Engine</p>
        </div>
        <nav class="mt-6 px-4 space-y-1">
            <button onclick="showTab('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-chart-line w-6 text-blue-500"></i> <span class="font-bold text-sm">Dashboard</span>
            </button>
            <button onclick="showTab('students')" class="sidebar-item w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-user-graduate w-6 text-indigo-500"></i> <span class="font-bold text-sm">Students</span>
            </button>
            <button onclick="showTab('fees')" class="sidebar-item w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-receipt w-6 text-green-500"></i> <span class="font-bold text-sm">Financials</span>
            </button>
            <div class="pt-6 pb-2 px-4"><p class="text-[10px] text-gray-400 font-black uppercase tracking-widest">Growth Intelligence</p></div>
            <button onclick="showTab('reports')" class="sidebar-item w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-chart-bar w-6 text-blue-600"></i> <span class="font-bold text-sm">Analysis</span> <i class="fas fa-lock ml-auto text-[9px] opacity-30"></i>
            </button>
            <button onclick="showTab('growth')" class="sidebar-item w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-bullseye w-6 text-red-500"></i> <span class="font-bold text-sm">Roadmap</span> <i class="fas fa-lock ml-auto text-[9px] opacity-30"></i>
            </button>
            <button onclick="showTab('financials')" class="sidebar-item w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition-all hover:bg-blue-50 group">
                <i class="fas fa-vault w-6 text-slate-600"></i> <span class="font-bold text-sm">Vault</span> <i class="fas fa-lock ml-auto text-[9px] opacity-30"></i>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-64 p-4 lg:p-12 text-center lg:text-left">
        <header class="flex justify-between items-center mb-12 flex-wrap gap-4 text-center lg:text-left">
            <button class="lg:hidden text-2xl p-3 bg-white rounded-2xl shadow-sm text-slate-800" onclick="window.toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div>
                <h2 id="pageTitle" class="text-4xl font-black tracking-tight text-slate-800">Dashboard</h2>
                <p id="currentDate" class="text-sm font-bold text-gray-400 mt-1"></p>
            </div>
            <div class="w-14 h-14 bg-white rounded-3xl shadow-sm flex items-center justify-center border border-gray-100 font-black text-blue-600 text-xl">FU</div>
        </header>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active space-y-10">
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-8">
                <div class="glass-card p-8 rounded-[2.5rem] border-b-8 border-blue-500">
                    <h3 class="text-gray-400 font-black text-[10px] uppercase tracking-widest text-center">Active Enrollment</h3>
                    <p id="statActive" class="text-5xl font-black mt-3 text-center">0</p>
                </div>
                <div class="glass-card p-8 rounded-[2.5rem] border-b-8 border-red-500">
                    <h3 class="text-gray-400 font-black text-[10px] uppercase tracking-widest text-center">Overdue</h3>
                    <p id="statOverdue" class="text-5xl font-black mt-3 text-red-600 text-center">0</p>
                </div>
                <div class="glass-card p-8 rounded-[2.5rem] border-b-8 border-green-500 text-center">
                    <h3 class="text-gray-400 font-black text-[10px] uppercase tracking-widest">Monthly Net</h3>
                    <p id="statProfit" class="text-4xl font-black mt-3 text-green-600 tracking-tight">â‚¹0</p>
                    <div class="flex justify-between text-[9px] font-black mt-4 bg-gray-50 p-2 rounded-xl border border-gray-100 uppercase tracking-widest">
                        <span class="text-blue-500" id="statMonthlyRev">In: â‚¹0</span>
                        <span class="text-red-500" id="statMonthlyExp">Out: â‚¹0</span>
                    </div>
                </div>
                <div class="glass-card p-8 rounded-[2.5rem] border-b-8 border-indigo-500 text-center">
                    <h3 class="text-gray-400 font-black text-[10px] uppercase tracking-widest">Total Valuation</h3>
                    <p id="statRevenue" class="text-4xl font-black mt-3 text-indigo-700 tracking-tight">â‚¹0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                <div class="glass-card p-10 rounded-[3rem] custom-shadow">
                    <h4 class="font-black text-lg mb-8 flex items-center justify-center lg:justify-start gap-3"><i class="fas fa-chart-line text-blue-500"></i> Monthly Income Trend</h4>
                    <canvas id="revenueChart" class="w-full max-h-[300px]"></canvas>
                </div>
                <div class="bg-slate-900 p-10 rounded-[3rem] text-white shadow-2xl relative overflow-hidden flex flex-col justify-between">
                    <div class="relative z-10 text-center sm:text-left">
                        <h3 class="text-2xl font-black mb-10 border-b border-white/10 pb-6">Business Reinvestment Bucket</h3>
                        <div id="miniAlloc" class="space-y-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STUDENTS TAB -->
        <div id="students" class="tab-content space-y-8">
            <div class="flex justify-between items-center flex-wrap gap-6 text-center sm:text-left">
                <h3 class="text-2xl font-black">Student Database</h3>
                <div class="flex gap-4 flex-wrap justify-center">
                    <div class="flex gap-2 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                        <select id="courseFilter" class="p-2 text-xs border-none outline-none font-black bg-slate-50 rounded-xl" onchange="window.updateUI()">
                            <option value="all">All Courses</option>
                        </select>
                        <select id="sortOrder" class="p-2 text-xs border-none outline-none font-black bg-slate-50 rounded-xl" onchange="window.updateUI()">
                            <option value="name-asc">A-Z Name</option>
                            <option value="date-desc">Newest Admissions</option>
                            <option value="due-asc">Due Soonest</option>
                        </select>
                    </div>
                    <button onclick="window.openModal('studentModal')" class="bg-blue-600 text-white px-8 py-4 rounded-2xl hover:bg-blue-700 font-black shadow-xl transition-all">
                        <i class="fas fa-plus"></i> New Student
                    </button>
                </div>
            </div>
            <div class="glass-card rounded-[3rem] overflow-hidden custom-shadow">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-center">
                        <thead class="bg-slate-50 border-b border-slate-100 text-center">
                            <tr class="text-center">
                                <th class="p-8 font-black text-slate-400 uppercase text-[10px] tracking-widest text-left">Student Profile</th>
                                <th class="p-8 font-black text-slate-400 uppercase text-[10px] tracking-widest text-center">Fee Tracking</th>
                                <th class="p-8 font-black text-slate-400 uppercase text-[10px] tracking-widest text-center">Due Cycle</th>
                                <th class="p-8 font-black text-slate-400 uppercase text-[10px] tracking-widest text-center">Status</th>
                                <th class="p-8 font-black text-slate-400 uppercase text-[10px] tracking-widest text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="text-center"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ledger fees -->
        <div id="fees" class="tab-content space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 text-center">
                <div class="lg:col-span-1 space-y-10">
                    <div class="glass-card p-10 rounded-[3rem] custom-shadow text-center">
                        <h4 class="font-black text-xl mb-8 text-blue-600 flex items-center justify-center sm:justify-start gap-3" id="feeFormTitle"><i class="fas fa-wallet"></i> Record Payment</h4>
                        <form id="feeForm" class="space-y-6 text-center">
                            <input type="hidden" id="editTransId">
                            <div id="studentSelectContainer" class="text-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Student</label>
                                <select id="feeStudentSelect" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 outline-none font-bold text-sm text-center" required></select>
                            </div>
                            <div id="studentNameDisplay" class="hidden text-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Correction Mode</label>
                                <p id="editStudentName" class="p-5 bg-blue-50 text-blue-800 rounded-2xl font-black text-sm mt-2 text-center"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Amount (â‚¹)</label>
                                    <input type="number" id="feeAmount" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 outline-none font-bold text-center" required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Type</label>
                                    <select id="feeType" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 outline-none font-bold text-center">
                                        <option value="Monthly">Monthly Fee</option>
                                        <option value="Admission">Admission Fee</option>
                                        <option value="Advance">Bulk Advance</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Date</label>
                                <input type="date" id="feeDate" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 outline-none font-bold text-center" required>
                            </div>
                            <div class="flex gap-2 text-center">
                                <button type="submit" id="feeSubmitBtn" class="flex-1 bg-blue-600 text-white py-6 rounded-3xl font-black hover:bg-blue-700 shadow-xl transition-all">Log Receipt</button>
                                <button type="button" id="cancelFeeEditBtn" onclick="window.resetFeeForm()" class="hidden px-8 bg-slate-200 text-slate-700 rounded-3xl font-black hover:bg-slate-300">Esc</button>
                            </div>
                        </form>
                    </div>

                    <div class="glass-card p-10 rounded-[3rem] border border-red-50 shadow-sm text-center">
                        <h4 class="font-black text-xl mb-8 text-red-600 flex items-center justify-center sm:justify-start gap-3"><i class="fas fa-shopping-basket"></i> Expense Entry</h4>
                        <form id="expenseForm" class="space-y-6 text-center">
                            <input type="hidden" id="editExpId">
                            <div class="text-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Purpose</label>
                                <input type="text" id="expName" placeholder="Electricity, Food, etc" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 text-center font-bold" required>
                            </div>
                            <div class="text-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Category</label>
                                <select id="expCategory" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 text-center font-bold">
                                    <option value="Essentials">Essentials (35%)</option>
                                    <option value="Reinvestment">Growth (20%)</option>
                                    <option value="Salaries">Staff Payroll</option>
                                    <option value="Others">Misc</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Amount (â‚¹)</label>
                                    <input type="number" id="expAmount" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 text-center font-bold" required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center text-center">Date</label>
                                    <input type="date" id="expDate" class="w-full p-5 bg-slate-50 border-none rounded-2xl mt-2 text-center font-bold" required>
                                </div>
                            </div>
                            <div class="flex gap-2 text-center">
                                <button type="submit" id="expSubmitBtn" class="flex-1 bg-red-500 text-white py-6 rounded-3xl font-black hover:bg-red-600 shadow-xl transition-all">Submit Expense</button>
                                <button type="button" id="cancelExpEditBtn" onclick="window.resetExpForm()" class="hidden px-8 bg-slate-200 text-slate-700 rounded-3xl font-black">Esc</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2 glass-card p-10 rounded-[3rem] h-full custom-shadow text-center">
                    <h4 class="font-black text-xl mb-8 text-center sm:text-left text-center">Institute Ledger (Last 50)</h4>
                    <div id="transactionList" class="space-y-6 max-h-[1000px] overflow-y-auto pr-4 custom-scrollbar text-center"></div>
                </div>
            </div>
        </div>

        <!-- reports tab -->
        <div id="reports" class="tab-content space-y-10">
            <div class="flex justify-between items-center flex-wrap gap-6 text-center">
                <h3 class="text-3xl font-black text-center sm:text-left text-center">Growth Analytics</h3>
                <div class="flex gap-3 bg-white p-2 rounded-2xl shadow-sm border border-slate-100 text-center">
                    <select id="reportYear" class="p-3 text-sm border-none outline-none font-black bg-slate-50 rounded-xl" onchange="window.updateUI()"></select>
                    <select id="reportMonth" class="p-3 text-sm border-none outline-none font-black bg-slate-50 rounded-xl" onchange="window.updateUI()">
                        <option value="all">Full Analysis</option>
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <div class="glass-card p-10 rounded-[3rem] custom-shadow border-l-[12px] border-blue-600 text-center flex flex-col justify-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Period Revenue</p>
                    <p id="repTotalRev" class="text-5xl font-black mt-4 text-center tracking-tighter">â‚¹0</p>
                    <div class="mt-12 pt-12 border-t border-slate-50 space-y-5 font-bold text-sm text-center">
                        <div class="flex justify-between"><span>Admission Track</span><span id="repAdmFee" class="text-blue-600 font-black">â‚¹0</span></div>
                        <div class="flex justify-between"><span>Monthly Cycle</span><span id="repMlyFee" class="text-green-600 font-black">â‚¹0</span></div>
                    </div>
                </div>
                <div class="lg:col-span-2 glass-card p-10 rounded-[3rem] custom-shadow text-center">
                    <h4 class="font-black text-lg mb-8 text-center sm:text-left"><i class="fas fa-chart-bar text-green-500 mr-2 text-center sm:text-left"></i> Monthly Cash Flow vs Expenses</h4>
                    <canvas id="cashFlowChart" class="w-full max-h-[300px] text-center"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 text-center">
                <div class="glass-card p-10 rounded-[3rem] custom-shadow text-center">
                    <h4 class="font-black text-lg mb-8 text-center sm:text-left text-center"><i class="fas fa-chart-pie text-indigo-500 mr-2 text-center"></i> Student Distribution</h4>
                    <canvas id="coursePieChart" class="w-full max-h-[300px] mx-auto text-center"></canvas>
                </div>
                <div class="glass-card p-10 rounded-[3rem] custom-shadow text-center">
                    <h4 class="font-black text-lg mb-8 text-center sm:text-left text-center"><i class="fas fa-chart-bar text-blue-500 mr-2 text-center"></i> Monthly Admissions</h4>
                    <canvas id="admissionsChart" class="w-full max-h-[300px] mx-auto text-center"></canvas>
                </div>
            </div>
        </div>

        <!-- Roadmap -->
        <div id="growth" class="tab-content space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 text-center">
                <div class="lg:col-span-2 glass-card p-10 rounded-[3rem] border-b-8 border-blue-600 text-center">
                    <h4 class="font-black text-xl mb-10 text-center sm:text-left text-center">Growth Roadmap 2026-2027</h4>
                    <div class="overflow-x-auto text-center">
                        <table class="w-full text-left text-center">
                            <thead class="text-center">
                                <tr class="text-slate-400 uppercase text-[10px] font-black border-b tracking-widest text-center">
                                    <th class="pb-8">Milestone Target</th>
                                    <th class="pb-8 text-center">Enrolled</th>
                                    <th class="pb-8 text-right">Result</th>
                                </tr>
                            </thead>
                            <tbody id="performanceBody" class="text-center"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-blue-600 text-white p-12 rounded-[3.5rem] shadow-2xl relative overflow-hidden text-center flex flex-col justify-center">
                    <div class="relative z-10 text-center">
                        <h3 id="growthPhaseTitle" class="text-3xl font-black text-center text-center"></h3>
                        <p id="growthPhaseDesc" class="text-sm opacity-80 mt-6 leading-relaxed font-medium text-center"></p>
                        <div class="mt-12 space-y-5 text-center" id="growthChecklist"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- financials Vault -->
        <div id="financials" class="tab-content space-y-8">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-center">
                <div class="glass-card p-12 rounded-[4rem] custom-shadow text-center" id="allocationStats"></div>
                <div class="flex flex-col gap-10 text-center">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-blue-100 text-center lg:text-left text-center">
                        <h4 class="font-black text-xl mb-8 text-blue-600 flex items-center justify-center lg:justify-start gap-3 text-center">
                            <i class="fas fa-key text-center text-center"></i> Security Management
                        </h4>
                        <div class="space-y-6 text-center">
                            <div class="text-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Owner PIN Access</label>
                                <input type="password" id="newPin" maxlength="4" class="w-full p-5 bg-slate-50 border-none rounded-3xl mt-2 text-center text-2xl font-black tracking-[1.5em] outline-none text-center">
                            </div>
                            <button onclick="window.updatePin()" class="w-full bg-blue-600 text-white py-6 rounded-3xl font-black hover:bg-blue-700 shadow-xl transition-all text-center">Confirm Access Update</button>
                        </div>
                    </div>
                    <div class="bg-slate-900 text-white p-12 rounded-[4rem] shadow-2xl text-center">
                        <h4 class="font-black text-xl mb-10 text-blue-400 text-center text-center">Accounting Utility</h4>
                        <button onclick="window.recalculateBalances()" class="w-full bg-blue-500/10 text-blue-400 border border-blue-400/30 hover:bg-blue-500/20 font-black py-5 rounded-3xl flex items-center justify-center gap-3 mb-6 transition-all text-center">
                            <i class="fas fa-calculator text-center"></i> Scan History & Repair Balances
                        </button>
                        <button onclick="window.exportBackup()" class="w-full bg-white/10 hover:bg-white/20 text-white font-black py-5 rounded-3xl flex items-center justify-center gap-3 transition-all text-center">
                            <i class="fas fa-cloud-arrow-down text-center"></i> Secure Database Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center z-[100] p-4 lg:p-8 backdrop-blur-xl">
        <div class="bg-white w-full max-w-6xl rounded-[4rem] shadow-2xl relative overflow-hidden flex flex-col max-h-[95vh] text-center sm:text-left text-center">
            <div class="p-8 lg:p-14 overflow-y-auto w-full text-center sm:text-left text-center">
                <button onclick="window.closeModal('studentModal')" class="absolute top-10 right-10 text-slate-300 hover:text-slate-800 text-4xl font-light transition-all text-center">&times;</button>
                
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-16 text-center sm:text-left text-center">
                    <!-- Left Profile -->
                    <div class="lg:col-span-4 border-r border-slate-50 pr-4 lg:pr-14 text-center sm:text-left text-center">
                        <div class="flex flex-col items-center text-center mb-12 text-center">
                            <div class="w-24 h-24 bg-blue-600 rounded-[3rem] flex items-center justify-center text-white text-4xl font-black shadow-2xl mb-6 text-center">FU</div>
                            <h3 class="text-4xl font-black text-slate-800 tracking-tighter text-center" id="studentModalTitle">Admission Entry</h3>
                            <span class="mt-4 px-5 py-2 bg-blue-50 text-blue-600 rounded-full text-[10px] font-black uppercase tracking-[0.2em] border border-blue-100 text-center" id="profileStatusBadge">Inactive</span>
                        </div>

                        <form id="enrollmentForm" class="space-y-6 text-center">
                            <input type="hidden" id="editStudentId">
                            <div class="space-y-2 text-center">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Full Student Name</label>
                                <input type="text" id="stuName" class="w-full p-5 bg-slate-50 border-none rounded-3xl font-bold text-center" required>
                            </div>
                            <div class="space-y-2 text-center">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Target Course</label>
                                <select id="stuCourse" class="w-full p-5 bg-slate-50 border-none rounded-3xl font-bold text-sm text-center" required></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="space-y-2 text-center">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Adm. (â‚¹)</label>
                                    <input type="number" id="stuAdmFee" class="w-full p-5 bg-slate-50 border-none rounded-3xl font-bold text-center" required>
                                </div>
                                <div class="space-y-2 text-center">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Mly. (â‚¹)</label>
                                    <input type="number" id="stuMlyFee" class="w-full p-5 bg-slate-50 border-none rounded-3xl font-bold text-center" required>
                                </div>
                            </div>
                            <div class="space-y-2 text-center">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Phone</label>
                                <input type="text" id="stuPhone" class="w-full p-5 bg-slate-50 border-none rounded-3xl font-bold text-center" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="space-y-2 text-center">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Joined</label>
                                    <input type="date" id="stuDate" class="w-full p-4 bg-slate-50 border-none rounded-3xl font-bold text-center text-center" required onchange="window.handleJoiningDateChange(this.value)">
                                </div>
                                <div class="space-y-2 text-center">
                                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Cycle</label>
                                    <input type="date" id="stuDueDate" class="w-full p-4 bg-slate-50 border-none rounded-3xl font-bold text-center text-center" required>
                                </div>
                            </div>
                            <button type="submit" id="studentSubmitBtn" class="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black hover:bg-slate-800 shadow-xl transition-all mt-6 text-center text-center">Authorize Record</button>
                        </form>
                    </div>

                    <!-- Right Timeline -->
                    <div id="studentHistoryPanel" class="lg:col-span-8 flex flex-col h-full hidden text-center">
                        <div class="grid grid-cols-3 gap-8 mb-12 text-center">
                            <div class="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 text-center">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 text-center">Account Paid</p>
                                <p class="text-4xl font-black text-slate-800 text-center" id="stuTotalPaid">â‚¹0</p>
                            </div>
                            <div class="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 text-center">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 text-center text-center">Due Status</p>
                                <p class="text-xs font-black uppercase text-center mt-3 text-center" id="stuDueStatusLabel"></p>
                            </div>
                            <div class="p-8 bg-blue-600 rounded-[2.5rem] shadow-2xl text-white flex items-center justify-center text-center text-center">
                                <button onclick="window.quickAddFeeFromProfile()" class="flex flex-col items-center gap-3 group text-center text-center">
                                    <i class="fas fa-cash-register text-3xl group-hover:scale-125 transition-transform text-center text-center"></i>
                                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-center text-center">Record New Fee</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col text-center">
                            <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.4em] mb-8 flex items-center justify-center gap-6 text-center text-center">
                                <span class="w-16 h-[1px] bg-slate-100"></span> Billing Log <span class="w-16 h-[1px] bg-slate-100"></span>
                            </h4>
                            <div class="overflow-y-auto space-y-6 pr-6 custom-scrollbar text-center" id="stuPaymentHistoryList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Block -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG & CONSTANTS
        const firebaseConfig = { apiKey: "AIzaSyB2bcDcHkL7mtu8Hy_XsrrCnJ1TRfzJNyc", authDomain: "futureuerp.firebaseapp.com", projectId: "futureuerp", storageBucket: "futureuerp.firebasestorage.app", messagingSenderId: "199842262718", appId: "1:199842262718:web:553ca10bb5da77656478ef", measurementId: "G-WHXM1VDGZY" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'futureuerp';

        const COURSE_LIST = ["DIFAâ€“ Diploma in Indian and Foreign Accounting", "PDIFAâ€“ Professional Diploma in Indian & Foreign Accounting", "DFAâ€“ Diploma in Financial Accounting", "PGDCAâ€“ Post Graduate Diploma in Computer Application", "DCAâ€“Diploma in Computer Application", "DOMâ€“Diploma in Office Management", "Graphic Designing + Digital Marketing", "NIOS", "Vacation Course", "JAVA Programming", "PYTHON Programming", "HTML", "Zoho Books", "Tally Prime", "Adobe Photoshop", "Adobe PageMaker", "Adobe InDesign", "Microsoft Excel", "Microsoft Office Suite", "PSC Coaching", "SSC Coaching", "RRB Coaching", "SSC + RRB Coaching", "Reading Room / Study Centre Access"];
        const TARGETS = [{m:"Jan",y:2026,t:25},{m:"Feb",y:2026,t:40},{m:"Mar",y:2026,t:60},{m:"Apr",y:2026,t:80},{m:"May",y:2026,t:100},{m:"Dec",y:2026,t:250},{m:"Dec",y:2027,t:500}];
        const MONTH_MAP = { "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5, "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11 };

        let appState = { students: [], transactions: [], expenses: [], user: null, adminPin: '4568', isAuthenticated: false, currentInputPin: '', targetTab: 'dashboard' };
        let charts = { revenue: null, cashFlow: null, course: null, admissions: null };

        // UI CORE
        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        const safeSetHTML = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };
        const showNotif = (msg) => { const n = document.getElementById('notif'); if (n) { n.innerText = msg; n.classList.remove('hidden'); setTimeout(() => n.classList.add('hidden'), 3000); } };

        const updateCharts = (trans, exps, students) => {
            const chartConfig = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
            
            // Admissions Bar Chart
            const ctxAdm = document.getElementById('admissionsChart')?.getContext('2d');
            if(ctxAdm) {
                const months = ["Jan", "Feb", "Mar", "Apr", "May"];
                const admCounts = months.map(m => students.filter(s => { const [y,mo] = s.date.split('-'); return MONTH_MAP[m] === Number(mo)-1 && y === "2026"; }).length);
                if(charts.admissions) charts.admissions.destroy();
                charts.admissions = new Chart(ctxAdm, { type: 'bar', data: { labels: months, datasets: [{ data: admCounts, backgroundColor: '#3b82f6', borderRadius: 8 }] }, options: chartConfig });
            }

            // Cash Flow Comparison
            const ctxCash = document.getElementById('cashFlowChart')?.getContext('2d');
            if(ctxCash) {
                const months = ["Jan", "Feb", "Mar"];
                const inData = months.map(m => trans.filter(t => { const [y,mo] = t.paidDate.split('-'); return MONTH_MAP[m] === Number(mo)-1 && y === "2026"; }).reduce((a,b)=>a+Number(b.amount),0));
                const outData = months.map(m => exps.filter(e => { const [y,mo] = e.date.split('-'); return MONTH_MAP[m] === Number(mo)-1 && y === "2026"; }).reduce((a,b)=>a+Number(b.amount),0));
                if(charts.cashFlow) charts.cashFlow.destroy();
                charts.cashFlow = new Chart(ctxCash, { type: 'bar', data: { labels: months, datasets: [{ label: 'Income', data: inData, backgroundColor: '#22c55e' }, { label: 'Expense', data: outData, backgroundColor: '#ef4444' }] }, options: { ...chartConfig, plugins: { legend: { display: true } } } });
            }
        };

        const isPeriodMatch = (dateStr, month, year) => {
            if (!dateStr) return false;
            const [y, m, d] = dateStr.split('-').map(Number);
            if (month === 'all') return y === Number(year);
            return y === Number(year) && (m - 1) === Number(month);
        };

        const updateUI = () => {
            const today = new Date();
            const currMoIdx = today.getMonth();
            const currYr = today.getFullYear();
            
            // Get Filters
            const cFilter = document.getElementById('courseFilter')?.value || 'all';
            const sOrder = document.getElementById('sortOrder')?.value || 'name-asc';

            let displayStudents = [...appState.students];
            if(cFilter !== 'all') displayStudents = displayStudents.filter(s => s.course === cFilter);

            // Sorting
            displayStudents.sort((a,b) => {
                if(sOrder === 'name-asc') return a.name.localeCompare(b.name);
                if(sOrder === 'date-desc') return new Date(b.date) - new Date(a.date);
                if(sOrder === 'due-asc') return new Date(a.nextDueDate) - new Date(b.nextDueDate);
                return 0;
            });

            const activeStudents = appState.students.filter(s => s.status === 'Active');
            const overdue = activeStudents.filter(s => new Date(s.nextDueDate) < today);

            safeSetText('statActive', activeStudents.length);
            safeSetText('statOverdue', overdue.length);
            safeSetText('statRevenue', `â‚¹${appState.transactions.reduce((a,b)=>a+Number(b.amount),0).toLocaleString()}`);

            const monthlyRev = appState.transactions.filter(t => isPeriodMatch(t.paidDate, currMoIdx, currYr)).reduce((a, b) => a + (Number(b.amount) || 0), 0);
            const monthlyExp = appState.expenses.filter(e => isPeriodMatch(e.date, currMoIdx, currYr)).reduce((a, b) => a + (Number(b.amount) || 0), 0);
            safeSetText('statProfit', `â‚¹${(monthlyRev - monthlyExp).toLocaleString()}`);
            safeSetText('statMonthlyRev', `In: â‚¹${monthlyRev.toLocaleString()}`);
            safeSetText('statMonthlyExp', `Out: â‚¹${monthlyExp.toLocaleString()}`);

            safeSetText('visionProgressText', `${activeStudents.length} / 500`);
            const bar = document.getElementById('visionBar'); if (bar) bar.style.width = Math.min((activeStudents.length / 500) * 100, 100) + '%';

            // Main Table
            safeSetHTML('studentTableBody', displayStudents.map(s => `
                <tr class="border-b hover:bg-gray-50/50 transition-all text-sm text-center">
                    <td class="p-8 text-left"><p class="font-black text-slate-800">${s.name}</p><p class="text-[10px] text-gray-400 font-bold text-left">${s.phone || 'No Contact'}</p></td>
                    <td class="p-8 text-xs font-bold text-slate-600 text-center">${s.course}</td>
                    <td class="p-8 font-black text-blue-600 text-center">â‚¹${s.mlyFee}</td>
                    <td class="p-8 text-center"><span class="px-3 py-1.5 rounded-lg font-black text-[10px] ${new Date(s.nextDueDate) < today ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${s.nextDueDate}</span></td>
                    <td class="p-8 text-center"><span class="px-3 py-1.5 rounded-full text-[10px] font-black ${s.status === 'Active' ? 'status-badge-active' : 'status-badge-stopped'}">${s.status}</span></td>
                    <td class="p-8 flex gap-2 justify-end"><button onclick="window.editStudent('${s.id}')" class="p-3 bg-white rounded-xl text-slate-300 hover:text-blue-600 shadow-sm transition-all text-center"><i class="fas fa-edit text-center"></i></button><button onclick="window.deleteStudent('${s.id}')" class="p-3 bg-white rounded-xl text-slate-300 hover:text-red-500 shadow-sm transition-all text-center"><i class="fas fa-trash-alt text-center"></i></button></td>
                </tr>
            `).join(''));

            // Performance Table
            safeSetHTML('performanceBody', TARGETS.map(target => {
                const targetMoIdx = MONTH_MAP[target.m];
                const admissionsCount = appState.students.filter(s => { if (!s.date) return false; const [y, m, d] = s.date.split('-').map(Number); return (m - 1) === targetMoIdx && y === target.y; }).length;
                const status = admissionsCount >= target.t ? 'âœ… Met' : 'ðŸ“ˆ Ongoing';
                return `<tr class="border-b border-gray-50 text-center"><td class="py-6 font-black text-left">${target.m} ${target.y}</td><td class="py-6 font-black text-center">${admissionsCount} / ${target.t}</td><td class="py-6 text-right"><span class="px-2 py-1 rounded-full text-[10px] font-black ${admissionsCount >= target.t ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${status}</span></td></tr>`;
            }).join(''));

            // Allocation Cards
            const al = [{ n: 'Essentials', v: 0.35, c: 'blue' }, { n: 'Reinvestment', v: 0.20, c: 'indigo' }, { n: 'Debt', v: 0.20, c: 'red' }, { n: 'Savings', v: 0.15, c: 'green' }, { n: 'Personal', v: 0.10, c: 'yellow' }];
            const totalRevenue = appState.transactions.reduce((a,b)=>a+Number(b.amount),0);
            safeSetHTML('allocationStats', `<h4 class="font-black mb-12 text-2xl text-center">Money Allocation Map</h4>` + al.map(cat => `<div class="mb-8"><div class="flex justify-between text-xs font-black mb-2 uppercase tracking-widest text-center"><span>${cat.n} (${cat.v*100}%)</span><span>â‚¹${Math.floor(totalRevenue*cat.v).toLocaleString()}</span></div><div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden text-center"><div class="bg-${cat.c}-500 h-full shadow-sm transition-all duration-1000 text-center" style="width:${cat.v*100}%"></div></div></div>`).join(''));
            safeSetHTML('miniAlloc', al.slice(0, 3).map(cat => `<div class="flex justify-between text-[11px] font-black opacity-80 uppercase tracking-widest"><span>${cat.n}</span><span>â‚¹${Math.floor(totalRevenue*cat.v).toLocaleString()}</span></div>`).join(''));

            updateCharts(appState.transactions, appState.expenses, appState.students);
        };

        // EXPOSE GLOBALS
        window.updateUI = updateUI;
        window.openModal = (id) => { const el = document.getElementById(id); if (el) el.style.display = 'flex'; };
        window.closeModal = (id) => { const el = document.getElementById(id); if (el) el.style.display = 'none'; if(id === 'studentModal') resetStudentModal(); };
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); };
        window.pressPin = (num) => { if(appState.currentInputPin.length < 4) { appState.currentInputPin += num; updatePinVisuals(); if(appState.currentInputPin.length === 4) validatePin(); } };
        window.clearPin = () => { appState.currentInputPin = ''; updatePinVisuals(); };
        window.cancelPin = () => { clearPin(); document.getElementById('pinOverlay').classList.add('hidden'); };
        const updatePinVisuals = () => { for(let i = 1; i <= 4; i++) { const dot = document.getElementById(`pin-${i}`); if(dot) { if(appState.currentInputPin.length >= i) dot.classList.add('bg-blue-500', 'border-blue-500', 'scale-125'); else dot.classList.remove('bg-blue-500', 'border-blue-500', 'scale-125'); } } };
        const validatePin = () => { if(appState.currentInputPin === appState.adminPin) { appState.isAuthenticated = true; showNotif("Access Granted"); document.getElementById('pinOverlay').classList.add('hidden'); window.showTab(appState.targetTab); clearPin(); } else { showNotif("Access Denied"); clearPin(); } };

        window.handleJoiningDateChange = (val) => {
            if(!val) return;
            const date = new Date(val); date.setDate(date.getDate() + 30);
            const dueInp = document.getElementById('stuDueDate'); if(dueInp) dueInp.value = date.toISOString().split('T')[0];
        };

        window.showTab = (tabId) => {
            if((tabId === 'growth' || tabId === 'financials' || tabId === 'reports') && !appState.isAuthenticated) {
                appState.targetTab = tabId; document.getElementById('pinOverlay').classList.remove('hidden'); return;
            }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const targetEl = document.getElementById(tabId); if (targetEl) targetEl.classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.toggle('active', el.getAttribute('onclick').includes(tabId)));
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                const titles = { reports: "Detailed Analysis", growth: "Roadmap Scoreboard", financials: "Financial Vault", dashboard: "Control Panel", students: "Student Database", fees: "Income Ledger" };
                pageTitle.innerText = titles[tabId] || tabId.charAt(0).toUpperCase() + tabId.slice(1);
            }
            updateUI();
        };

        const resetStudentModal = () => {
            document.getElementById('editStudentId').value = '';
            document.getElementById('enrollmentForm').reset();
            document.getElementById('studentModalTitle').innerText = "Admission Registry";
            document.getElementById('studentSubmitBtn').innerText = "Authorize Entry";
            document.getElementById('studentHistoryPanel').classList.add('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stuDate').value = today;
            window.handleJoiningDateChange(today);
        };

        window.editStudent = (id) => {
            const s = appState.students.find(stu => stu.id === id);
            if (!s) return;
            document.getElementById('editStudentId').value = id;
            document.getElementById('stuName').value = s.name;
            document.getElementById('stuCourse').value = s.course;
            document.getElementById('stuAdmFee').value = s.admFee;
            document.getElementById('stuMlyFee').value = s.mlyFee;
            document.getElementById('stuPhone').value = s.phone || '';
            document.getElementById('stuDate').value = s.date;
            document.getElementById('stuDueDate').value = s.nextDueDate;
            document.getElementById('studentModalTitle').innerText = `${s.name}'s Profile`;
            document.getElementById('studentSubmitBtn').innerText = "Save Changes";
            document.getElementById('studentHistoryPanel').classList.remove('hidden');
            
            const isOverdue = new Date(s.nextDueDate) < new Date();
            safeSetText('stuTotalPaid', `â‚¹${(s.totalPaid || 0).toLocaleString()}`);
            safeSetHTML('stuDueStatusLabel', `<span class="${isOverdue ? 'text-red-500' : 'text-blue-500'}">${isOverdue ? 'Cycle Overdue' : 'Cycle Current'}</span>`);

            const history = appState.transactions.filter(t => t.studentId === id).sort((a,b) => new Date(b.paidDate) - new Date(a.paidDate));
            safeSetHTML('stuPaymentHistoryList', history.map(t => `
                <div class="flex justify-between items-center p-6 bg-slate-50 rounded-[2rem] border border-slate-100 text-center">
                    <div><p class="text-[10px] font-black text-slate-800 uppercase tracking-widest text-center">${t.type}</p><p class="text-[8px] text-gray-400 font-bold mt-1 text-center">${t.paidDate}</p></div>
                    <div class="flex items-center gap-4 text-center"><p class="text-sm font-black text-slate-800 text-center">â‚¹${t.amount}</p>
                    <button onclick="window.editEntry('${t.id}', 'fee')" class="text-slate-300 hover:text-blue-600 transition-all text-center"><i class="fas fa-edit text-center"></i></button></div>
                </div>
            `).join('') || '<p class="text-xs text-gray-300 italic text-center py-10">No history found.</p>');
            window.openModal('studentModal');
        };

        window.editEntry = (id, kind) => {
            const list = kind === 'fee' ? appState.transactions : appState.expenses;
            const item = list.find(i => i.id === id);
            if (!item) return;
            if(kind === 'fee') {
                document.getElementById('editTransId').value = id;
                document.getElementById('feeAmount').value = item.amount;
                document.getElementById('feeType').value = item.type;
                document.getElementById('feeDate').value = item.paidDate;
                document.getElementById('feeFormTitle').innerText = "Correct Receipt";
                document.getElementById('studentSelectContainer').classList.add('hidden');
                document.getElementById('studentNameDisplay').classList.remove('hidden');
                document.getElementById('editStudentName').innerText = item.studentName;
                document.getElementById('cancelFeeEditBtn').classList.remove('hidden');
            } else {
                document.getElementById('editExpId').value = id;
                document.getElementById('expName').value = item.name;
                document.getElementById('expAmount').value = item.amount;
                document.getElementById('expCategory').value = item.category || 'Essentials';
                document.getElementById('expDate').value = item.date;
                document.getElementById('expFormTitle').innerText = "Correct Expense";
                document.getElementById('cancelExpEditBtn').classList.remove('hidden');
            }
            window.closeModal('studentModal');
            showTab('fees');
        };

        window.resetFeeForm = () => {
            document.getElementById('editTransId').value = '';
            document.getElementById('feeForm').reset();
            document.getElementById('feeFormTitle').innerText = "Fee Collection";
            document.getElementById('studentSelectContainer').classList.remove('hidden');
            document.getElementById('studentNameDisplay').classList.add('hidden');
            document.getElementById('cancelFeeEditBtn').classList.add('hidden');
            document.getElementById('feeDate').value = new Date().toISOString().split('T')[0];
        };

        window.resetExpForm = () => {
            document.getElementById('editExpId').value = '';
            document.getElementById('expenseForm').reset();
            document.getElementById('expFormTitle').innerText = "Log Expense";
            document.getElementById('cancelExpEditBtn').classList.add('hidden');
            document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
        };

        window.recalculateBalances = async () => {
            showNotif("System recalibrating ledger...");
            const totals = {};
            appState.transactions.forEach(t => { if(t.studentId) totals[t.studentId] = (totals[t.studentId] || 0) + Number(t.amount); });
            for(let sid in totals) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid), { totalPaid: totals[sid] }); }
            showNotif("Balance Integrity Restored.");
        };

        window.deleteEntry = async (id, kind) => {
            if (!confirm(`Delete this permanent record?`)) return;
            const col = kind === 'fee' ? 'transactions' : 'expenses';
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
            if (kind === 'fee') window.recalculateBalances();
            showNotif("Deleted.");
        };

        window.quickAddFeeFromProfile = () => {
            const sid = document.getElementById('editStudentId').value;
            const student = appState.students.find(s => s.id === sid);
            window.closeModal('studentModal');
            showTab('fees');
            setTimeout(() => {
                const sel = document.getElementById('feeStudentSelect');
                if(sel) { sel.value = sid; document.getElementById('feeAmount').value = student.mlyFee || 0; }
            }, 100);
        };

        window.copyNumbers = () => {
            const nums = appState.students.filter(s => s.status === 'Active').map(s => s.phone).filter(p => p).join(', ');
            const dummy = document.createElement("textarea"); document.body.appendChild(dummy);
            dummy.value = nums; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy);
            showNotif("Copied to clipboard!");
        };

        window.updatePin = async () => {
            const pin = document.getElementById('newPin').value;
            if(pin.length !== 4) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'admin'), { pin });
            showNotif("Owner Access Updated");
            document.getElementById('newPin').value = '';
        };

        window.exportBackup = () => {
            const data = { students: appState.students, transactions: appState.transactions, expenses: appState.expenses };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = `FutureU_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
        };

        window.toggleTask = (type) => { showNotif(`${type.toUpperCase()} task noted.`); };

        // SYNC & START
        const startSync = () => {
            if (!appState.user) return;
            const pinDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'admin');
            onSnapshot(pinDoc, (snap) => { if(snap.exists()) appState.adminPin = snap.data().pin; else setDoc(pinDoc, { pin: '4568' }); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => { appState.students = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (snap) => { appState.transactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snap) => { appState.expenses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI(); });
        };

        async function initApp() {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => { 
                if (user) { appState.user = user; document.getElementById('loadingOverlay').style.opacity = '0'; setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 500); startSync(); } 
            });
            const today = new Date().toISOString().split('T')[0];
            safeSetText('currentDate', new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
            safeSetHTML('stuCourse', COURSE_LIST.map(c => `<option value="${c}">${c}</option>`).join(''));
            safeSetHTML('courseFilter', '<option value="all">All Courses</option>' + COURSE_LIST.map(c => `<option value="${c}">${c}</option>`).join(''));
            const yrSelect = document.getElementById('reportYear');
            if(yrSelect) yrSelect.innerHTML = [2025, 2026, 2027].map(y => `<option value="${y}" ${y == new Date().getFullYear()?'selected':''}>${y}</option>`).join('');
            document.getElementById('reportMonth').value = new Date().getMonth();
        }

        // FORM LISTENERS
        document.getElementById('enrollmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editStudentId').value;
            const data = { name: document.getElementById('stuName').value, course: document.getElementById('stuCourse').value, admFee: Number(document.getElementById('stuAdmFee').value), mlyFee: Number(document.getElementById('stuMlyFee').value), phone: document.getElementById('stuPhone').value, date: document.getElementById('stuDate').value, nextDueDate: document.getElementById('stuDueDate').value };
            try {
                if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), data);
                else {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { ...data, status: 'Active', totalPaid: data.admFee, createdAt: new Date().toISOString() });
                    if (data.admFee > 0) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), { studentId: docRef.id, studentName: data.name, amount: data.admFee, type: 'Admission', paidDate: data.date, cycleDueDate: 'Initial' });
                }
                window.closeModal('studentModal'); showNotif("Registry Success");
            } catch (err) { showNotif("Error!"); }
        });

        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editTransId').value;
            const amount = Number(document.getElementById('feeAmount').value);
            const type = document.getElementById('feeType').value;
            const paidDate = document.getElementById('feeDate').value;
            try {
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', editId), { amount, type, paidDate });
                    window.recalculateBalances();
                } else {
                    const sId = document.getElementById('feeStudentSelect').value;
                    const student = appState.students.find(s => s.id == sId);
                    const nextDueObj = new Date(student.nextDueDate); nextDueObj.setDate(nextDueObj.getDate() + 30);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), { studentId: sId, studentName: student.name, amount, type, paidDate, cycleDueDate: student.nextDueDate });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sId), { nextDueDate: nextDueObj.toISOString().split('T')[0], totalPaid: (student.totalPaid || 0) + amount });
                }
                window.resetFeeForm(); showNotif("Receipt Logged");
            } catch (err) { showNotif("Error!"); }
        });

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editExpId').value;
            const data = { name: document.getElementById('expName').value, amount: Number(document.getElementById('expAmount').value), category: document.getElementById('expCategory').value, date: document.getElementById('expDate').value };
            try {
                if(editId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', editId), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), data);
                window.resetExpForm(); showNotif("Expense Logged");
            } catch (err) { showNotif("Error!"); }
        });

        initApp().catch(console.error);
    </script>
</body>
</html>

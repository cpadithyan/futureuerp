<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future U - Institute Management (Cloud Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .sidebar-item.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-badge-active { background-color: #dcfce7; color: #166534; }
        .status-badge-stopped { background-color: #fee2e2; color: #991b1b; }
        .status-badge-overdue { background-color: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
        #loadingOverlay { transition: opacity 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium">Connecting to Future U Cloud...</p>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                <i class="fas fa-graduation-cap"></i> Future U
            </h1>
            <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-widest font-bold">Cloud ERP Manager</p>
        </div>
        <nav class="mt-6 px-4 space-y-2">
            <button onclick="showTab('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-blue-50">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button onclick="showTab('students')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-blue-50">
                <i class="fas fa-users"></i> Student Database
            </button>
            <button onclick="showTab('fees')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-blue-50">
                <i class="fas fa-hand-holding-dollar"></i> Fee Ledger
            </button>
            <button onclick="showTab('financials')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-blue-50">
                <i class="fas fa-building-columns"></i> Financial Plan
            </button>
        </nav>
        <div class="absolute bottom-6 left-6 right-6">
            <div class="bg-blue-50 rounded-xl p-4">
                <p class="text-sm font-semibold text-blue-800">Growth Scoreboard</p>
                <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                    <div id="targetProgress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="targetText" class="text-xs mt-2 text-blue-600 font-medium">Syncing...</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="md:ml-64 p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <button class="md:hidden text-2xl" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p id="currentDate" class="text-sm text-gray-500 font-medium"></p>
                    <p id="cloudStatus" class="text-[10px] text-green-500 font-bold uppercase tracking-widest">● Cloud Connected</p>
                </div>
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">FU</div>
            </div>
        </header>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="text-gray-500 font-medium mb-1 text-sm uppercase">Active Students</h3>
                    <p id="statActive" class="text-3xl font-bold">0</p>
                    <span class="text-xs text-blue-500 font-semibold uppercase tracking-wider">Goal: 100</span>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-red-500">
                    <h3 class="text-gray-500 font-medium mb-1 text-sm uppercase">Overdue Fees</h3>
                    <p id="statOverdue" class="text-3xl font-bold text-red-600">0</p>
                    <span class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Follow-up Priority</span>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="text-gray-500 font-medium mb-1 text-sm uppercase">Total Collected</h3>
                    <p id="statRevenue" class="text-3xl font-bold">₹0</p>
                    <span class="text-xs text-green-500 font-semibold uppercase tracking-wider">Revenue Ledger</span>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="text-gray-500 font-medium mb-1 text-sm uppercase">Debt Repayment</h3>
                    <p id="statDebt" class="text-3xl font-bold text-red-400">₹0</p>
                    <span class="text-xs text-indigo-400 font-semibold uppercase tracking-wider">20% Logic</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-phone-alt text-blue-500"></i> Rural Follow-up List</h4>
                    <div id="followUpList" class="space-y-3">
                        <p class="text-sm text-gray-400 italic">Syncing active dues...</p>
                    </div>
                </div>
                <div class="bg-slate-900 p-8 rounded-2xl text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold mb-4">Strategic Allocation</h3>
                        <div id="miniAlloc" class="space-y-3"></div>
                    </div>
                    <div class="absolute -right-10 -bottom-10 opacity-10 text-8xl"><i class="fas fa-chart-pie"></i></div>
                </div>
            </div>
        </div>

        <!-- STUDENTS TAB -->
        <div id="students" class="tab-content space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Student Database</h3>
                <button onclick="openModal('studentModal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 font-semibold shadow-lg transition-all">
                    <i class="fas fa-user-plus mr-2"></i>New Admission
                </button>
            </div>
            <div class="glass-card rounded-2xl overflow-hidden shadow-sm border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Student</th>
                                <th class="p-4 font-semibold text-gray-600">Course</th>
                                <th class="p-4 font-semibold text-gray-600">Monthly Fee</th>
                                <th class="p-4 font-semibold text-gray-600">Next Due Date</th>
                                <th class="p-4 font-semibold text-gray-600">Status</th>
                                <th class="p-4 font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FEES TAB -->
        <div id="fees" class="tab-content space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="glass-card p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-4">
                        <h4 class="font-bold mb-4 text-blue-600 flex items-center gap-2"><i class="fas fa-coins"></i> Collect Fee</h4>
                        <form id="feeForm" class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Student</label>
                                <select id="feeStudentSelect" class="w-full p-3 bg-gray-50 border rounded-xl mt-1 outline-none" required></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Amount (₹)</label>
                                    <input type="number" id="feeAmount" class="w-full p-3 bg-gray-50 border rounded-xl mt-1 outline-none" required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Type</label>
                                    <select id="feeType" class="w-full p-3 bg-gray-50 border rounded-xl mt-1 outline-none">
                                        <option value="Monthly">Monthly Fee</option>
                                        <option value="Admission">Admission Fee</option>
                                        <option value="Advance">Bulk Advance</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Paid Date</label>
                                <input type="date" id="feeDate" class="w-full p-3 bg-gray-50 border rounded-xl mt-1 outline-none" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition-all">Submit to Cloud</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="glass-card p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h4 class="font-bold mb-4">Payment History (Last 50)</h4>
                        <div id="transactionList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FINANCIALS TAB -->
        <div id="financials" class="tab-content space-y-6">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass-card p-8 rounded-3xl shadow-sm" id="allocationStats"></div>
                <div class="bg-slate-900 text-white p-8 rounded-3xl shadow-xl flex flex-col justify-center">
                    <h4 class="font-bold text-lg mb-4 text-blue-400 flex items-center gap-2">
                        <i class="fas fa-shield-halved"></i> Cloud Data Protection
                    </h4>
                    <p class="text-sm opacity-80 leading-relaxed">
                        All financial records and student data are stored in a secured Firebase Firestore instance. 
                        Your data is encrypted in transit and at rest.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Admission Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[100] p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">New Enrollment</h3>
                <button onclick="closeModal('studentModal')" class="text-gray-400 hover:text-black text-3xl">&times;</button>
            </div>
            <form id="enrollmentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Student Name</label>
                    <input type="text" id="stuName" class="w-full p-4 border rounded-xl outline-none mt-1" required>
                </div>
                <div class="md:col-span-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Select Course</label>
                    <select id="stuCourse" class="w-full p-4 border rounded-xl outline-none mt-1" required></select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Adm. Fee (₹)</label>
                    <input type="number" id="stuAdmFee" value="500" class="w-full p-4 border rounded-xl mt-1 outline-none" required>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Monthly Fee (₹)</label>
                    <input type="number" id="stuMlyFee" value="1000" class="w-full p-4 border rounded-xl mt-1 outline-none" required>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Joining Date</label>
                    <input type="date" id="stuDate" class="w-full p-4 border rounded-xl mt-1 outline-none" required>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">First Due Date</label>
                    <input type="date" id="stuDueDate" class="w-full p-4 border rounded-xl mt-1 outline-none" required>
                </div>
                <div class="md:col-span-2 pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-xl transition-all">Enroll & Sync to Cloud</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notif" class="fixed bottom-6 right-6 hidden bg-gray-900 text-white px-8 py-4 rounded-2xl shadow-2xl z-[200]">Action Successful!</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB2bcDcHkL7mtu8Hy_XsrrCnJ1TRfzJNyc",
            authDomain: "futureuerp.firebaseapp.com",
            projectId: "futureuerp",
            storageBucket: "futureuerp.firebasestorage.app",
            messagingSenderId: "199842262718",
            appId: "1:199842262718:web:553ca10bb5da77656478ef",
            measurementId: "G-WHXM1VDGZY"
        };

        const COURSE_LIST = ["DIFA– Diploma in Indian and Foreign Accounting", "PDIFA– Professional Diploma in Indian & Foreign Accounting", "DFA– Diploma in Financial Accounting", "PGDCA– Post Graduate Diploma in Computer Application", "DCA–Diploma in Computer Application", "DOM–Diploma in Office Management", "Graphic Designing + Digital Marketing", "NIOS", "Vacation Course", "JAVA Programming", "PYTHON Programming", "HTML", "Zoho Books", "Tally Prime", "Adobe Photoshop", "Adobe PageMaker", "Adobe InDesign", "Microsoft Excel", "Microsoft Office Suite", "PSC Coaching", "SSC Coaching", "RRB Coaching", "SSC + RRB Coaching", "Reading Room / Study Centre Access"];

        // State & Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'futureuerp';
        
        let appState = {
            students: [],
            transactions: [],
            user: null
        };

        // UI Helpers
        const showNotif = (msg) => {
            const n = document.getElementById('notif');
            n.innerText = msg;
            n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3000);
        };

        const closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.closeModal = closeModal; // Make global for UI

        const showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.toggle('active', el.getAttribute('onclick').includes(tabId)));
            updateUI();
        };
        window.showTab = showTab;

        const toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
        window.toggleSidebar = toggleSidebar;

        // AUTH & SYNC
        const init = async () => {
            await signInAnonymously(auth);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    appState.user = user;
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 500);
                    startSync();
                }
            });

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('stuDate').value = today;
            document.getElementById('feeDate').value = today;
            const nextMonth = new Date(); nextMonth.setDate(nextMonth.getDate() + 30);
            document.getElementById('stuDueDate').value = nextMonth.toISOString().split('T')[0];
            document.getElementById('stuCourse').innerHTML = COURSE_LIST.map(c => `<option value="${c}">${c}</option>`).join('');
        };

        const startSync = () => {
            if (!appState.user) return;

            const studentRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
            onSnapshot(studentRef, (snapshot) => {
                appState.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (err) => console.error("Sync Students Error:", err));

            const transRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            onSnapshot(transRef, (snapshot) => {
                appState.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a,b) => new Date(b.paidDate) - new Date(a.paidDate));
                updateUI();
            }, (err) => console.error("Sync Transactions Error:", err));
        };

        // UI ENGINE
        const updateUI = () => {
            const today = new Date();
            const activeStudents = appState.students.filter(s => s.status === 'Active');
            const overdue = activeStudents.filter(s => new Date(s.nextDueDate) < today);

            document.getElementById('statActive').innerText = activeStudents.length;
            document.getElementById('statOverdue').innerText = overdue.length;
            
            const totalRev = appState.transactions.reduce((a, b) => a + (Number(b.amount) || 0), 0);
            document.getElementById('statRevenue').innerText = `₹${totalRev.toLocaleString()}`;
            document.getElementById('statDebt').innerText = `₹${(totalRev * 0.2).toLocaleString()}`;

            const prog = (activeStudents.length / 100) * 100;
            document.getElementById('targetProgress').style.width = Math.min(prog, 100) + '%';
            document.getElementById('targetText').innerText = `${activeStudents.length} / 100 Students`;

            // Table
            document.getElementById('studentTableBody').innerHTML = appState.students.map(s => {
                const isOverdue = new Date(s.nextDueDate) < today && s.status === 'Active';
                return `
                    <tr class="border-b hover:bg-gray-50 text-sm">
                        <td class="p-4"><p class="font-bold text-gray-800">${s.name}</p></td>
                        <td class="p-4"><p class="text-xs truncate max-w-[120px]" title="${s.course}">${s.course}</p></td>
                        <td class="p-4 font-semibold text-blue-600">₹${s.mlyFee}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded-lg font-bold text-[10px] ${isOverdue ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                                ${s.nextDueDate}
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold ${s.status === 'Active' ? 'status-badge-active' : 'status-badge-stopped'}">
                                ${s.status}
                            </span>
                        </td>
                        <td class="p-4 flex gap-3 items-center">
                            <button onclick="window.updateStatus('${s.id}', '${s.status === 'Active' ? 'Stopped' : 'Active'}')" class="text-gray-400 hover:text-blue-600 transition-colors">
                                <i class="fas ${s.status === 'Active' ? 'fa-stop-circle' : 'fa-play-circle'}"></i>
                            </button>
                            <button onclick="window.deleteStudent('${s.id}')" class="text-gray-300 hover:text-red-500 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Transactions
            document.getElementById('transactionList').innerHTML = appState.transactions.slice(0, 15).map(t => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                    <div>
                        <p class="font-bold text-gray-800">${t.studentName}</p>
                        <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">${t.paidDate} • Cycle: ${t.cycleDueDate}</p>
                    </div>
                    <p class="font-bold text-green-600 text-sm">+₹${t.amount}</p>
                </div>
            `).join('');

            // Follow-ups
            const followUps = overdue.sort((a,b) => new Date(a.nextDueDate) - new Date(b.nextDueDate));
            document.getElementById('followUpList').innerHTML = followUps.length ? followUps.slice(0, 5).map(s => `
                <div class="flex justify-between items-center p-3 bg-red-50 border border-red-100 rounded-xl">
                    <span class="text-xs font-bold text-red-700">${s.name}</span>
                    <span class="text-[10px] font-bold bg-white px-2 py-1 rounded-md text-red-500 shadow-sm">Due: ${s.nextDueDate}</span>
                </div>
            `).join('') : '<p class="text-sm text-gray-400 italic">Everyone is up to date!</p>';

            // Select
            document.getElementById('feeStudentSelect').innerHTML = '<option value="">Select Student...</option>' + 
                activeStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            // Allocation
            const al = [{ n: 'Essentials', v: 0.35, c: 'blue' }, { n: 'Reinvestment', v: 0.20, c: 'indigo' }, { n: 'Debt', v: 0.20, c: 'red' }, { n: 'Savings', v: 0.15, c: 'green' }, { n: 'Personal', v: 0.10, c: 'yellow' }];
            document.getElementById('allocationStats').innerHTML = `<h4 class="font-bold mb-6 text-xl">Monthly Budget Allocation</h4>` + al.map(cat => `
                <div class="mb-5">
                    <div class="flex justify-between text-xs font-bold mb-1"><span>${cat.n} (${cat.v*100}%)</span><span>₹${Math.floor(totalRev*cat.v).toLocaleString()}</span></div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full"><div class="bg-${cat.c}-500 h-1.5 rounded-full" style="width:${cat.v*100}%"></div></div>
                </div>
            `).join('');

            document.getElementById('miniAlloc').innerHTML = al.slice(0, 3).map(cat => `
                <div class="flex justify-between text-xs font-medium opacity-80">
                    <span>${cat.n}</span><span>₹${Math.floor(totalRev*cat.v).toLocaleString()}</span>
                </div>
            `).join('');
        };

        // ACTIONS
        document.getElementById('enrollmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const student = {
                name: document.getElementById('stuName').value,
                course: document.getElementById('stuCourse').value,
                admFee: Number(document.getElementById('stuAdmFee').value),
                mlyFee: Number(document.getElementById('stuMlyFee').value),
                date: document.getElementById('stuDate').value,
                nextDueDate: document.getElementById('stuDueDate').value,
                status: 'Active',
                totalPaid: 0,
                createdAt: new Date().toISOString()
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), student);
                showNotif('Student enrolled to cloud!');
                closeModal('studentModal');
                e.target.reset();
            } catch (err) { alert("Error saving student"); }
        });

        document.getElementById('feeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sId = document.getElementById('feeStudentSelect').value;
            const amount = Number(document.getElementById('feeAmount').value);
            const paidDate = document.getElementById('feeDate').value;
            const student = appState.students.find(s => s.id == sId);
            const oldDue = student.nextDueDate;

            const nextDueObj = new Date(paidDate);
            nextDueObj.setDate(nextDueObj.getDate() + 30);
            const nextDueDate = nextDueObj.toISOString().split('T')[0];

            try {
                // Add Transaction
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    studentId: sId, studentName: student.name, amount, type: document.getElementById('feeType').value,
                    paidDate, cycleDueDate: oldDue
                });
                // Update Student
                const sRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', sId);
                await updateDoc(sRef, { nextDueDate, totalPaid: (student.totalPaid || 0) + amount });
                
                showNotif('Payment synced successfully!');
                e.target.reset();
            } catch (err) { alert("Error saving payment"); }
        });

        window.updateStatus = async (id, status) => {
            const sRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', id);
            await updateDoc(sRef, { status });
            showNotif(`Status updated to ${status}`);
        };

        window.deleteStudent = async (id) => {
            if (confirm("Permanently delete student record?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id));
                showNotif("Record deleted");
            }
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'flex';

        init();
    </script>
</body>
</html>